{% load static %}
{% load i18n %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
      body::-webkit-scrollbar{
        display: none;
      }
      
    </style>
    <style>
      .blink {
        animation: blinker 1.5s linear infinite;
      }
      
      @keyframes blinker {
        50% {
          opacity: 0;
        }
      }

      .bg-black {
        background-color: #000000;
      }
    </style>
    <style>
      /* Styling for fallback message */
      #fallback-message {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          text-align: center;
          padding: 20px;
          font-size: 1.5em;
          z-index: 1000;
      }
  </style>
  <script>
    let wakeLock = null;
    const fallbackMessage = document.getElementById('fallback-message');

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock is active');

                
                // Handle the wake lock being released
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock was released');
                    requestWakeLock(); // Re-request the wake lock if released
                });
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        } else {
            // Wake Lock API is not supported, show fallback message
            fallbackMessage.style.display = 'block';
        }
    }

    // Request wake lock when the page loads
    requestWakeLock();
</script>
  </head>
  <body 
  {% if request.LANGUAGE_CODE == 'ar' %}
  dir="rtl" 
  {% endif %}
  
  class="bg-black">
    <table>
        <tr>
            <th>
            <img src="{% static 'assets\images\umrahflow_logo_white.png' %}" alt="" style="margin-left: 20px; margin-right: 20px; width: 150px;"> 
            </th>
            <th>
            <h1 class="text-light">{% trans "Live Field Operation Dashboard" %} - {{company}}</h1>
            </th>
            <th>
            </th>
    </tr>
    <table class="table table-sm" id="content_table">
        <thead class="thead-dark">
          <tr>
            <th scope="col" class="text-center">#</th>
            <th scope="col" class="text-center">{% trans "Date" %}</th>
            <th scope="col" class="text-center">{% trans "Time" %}</th>
            <th scope="col" class="text-center">{% trans "Voucher " %}</th>
            <th scope="col" class="text-center">{% trans "Agent" %}</th>
            <th scope="col" class="text-center">{% trans "Country" %}</th>
            <th scope="col" class="text-center">{% trans "PAX" %}</th>
            <th scope="col" class="text-center">{% trans "From" %}</th>
            <th scope="col" class="text-center">{% trans "To" %}</th>
            <th scope="col" class="text-center">{% trans "Transport Company" %}</th>
            <th scope="col" class="text-center">{% trans "Type" %}</th>
            <th scope="col" class="text-center">{% trans "Status" %}</th>
          </tr>
        </thead>
  

      </table>
      <footer class="footer fixed-bottom " >
        <div class="container text-center">
            <div class="row text-light">
              <div  style="width: 33%">
                <span>{% trans "Date" %}:</span>
                <strong class="text" id="date_now"></strong>
              </div>
              <div style="width: 33%">
                <span>{% trans "Time" %}:</span>
                <strong class="text" id="time_now"></strong>
              </div>
              <div style="width: 33%">
                <span>{% trans "Last Update" %}:</span>
                <strong class="text" id="last_status"></strong>
              </div>
              <div id="fallback-message">
                Your browser does not support the Wake Lock API. Please adjust your device settings to prevent the screen from sleeping.
              </div>
              
           
            </div>
           
            </div>
            

        </div>
    </footer>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script type="text/javascript">
      function refreshContent() {
        fetch('{% url "schedule_tracking_screen_content" company.schedule_screen_key "content" %}')
            .then(response => response.text())
            .then(data => {
                document.getElementById('content_table').innerHTML = data;
                document.getElementById('last_status').innerHTML = new Date().toLocaleTimeString();
              document.getElementById('last_status').classList.remove('blink');

                


            })
            .catch(error => {
              document.getElementById('last_status').innerHTML = 'Failed to get update from server.';
              console.log(document.getElementById('last_status').classList);
              document.getElementById('last_status').classList.add('blink');
            });
            }
    
    // Refresh content every 5 seconds (5000 milliseconds)
    setInterval(refreshContent, 6000);
    
    // Optionally, you can call the function immediately to load the content on page load
    refreshContent();
    </script>
    <script type="text/javascript" charset="utf-8">
      function padZero(num) {
        return num.toString().padStart(2, '0');
      }
  
      let a;
      let time;
      setInterval(() => {
        a = new Date();
        {% comment %} format date to d/m/Y {% endcomment %}
        date = padZero(a.getDate()) + '/' + padZero(a.getMonth() + 1) + '/' + a.getFullYear();
        time = padZero(a.getHours()) + ':' + padZero(a.getMinutes()) + ':' + padZero(a.getSeconds());
        document.getElementById('date_now').innerHTML = date; 
        document.getElementById('time_now').innerHTML = time;
      }, 1000);
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <audio id="beep" src="{% static 'sounds/chime_in.mp3' %}" preload="auto"></audio>
    <script>
        function checkPendingMovements() {
            const pendingRows = document.querySelectorAll('tr.pending');
            const beep = document.getElementById('beep');

            if (pendingRows.length > 0) {
                if (beep.paused) {
                    beep.play();
                }
            } else {
                if (!beep.paused) {
                    beep.pause();
                    beep.currentTime = 0;
                }
            }
        }

        setInterval(checkPendingMovements, 5000);
    </script>

  </body>
</html>